name: Full CI/CD Pipeline - TP08

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  ############################################
  # 1) BACKEND TESTS
  ############################################
  backend_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - name: Run backend tests
        run: go test ./... -v
        working-directory: backend


  ############################################
  # 2) FRONTEND TESTS
  ############################################
  frontend_tests:
    runs-on: ubuntu-latest
    needs: backend_tests
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Run frontend tests
        run: npm test -- --watchAll=false
        working-directory: frontend


  ############################################
  # 3) SONARCLOUD
  ############################################
  sonarqube:
    runs-on: ubuntu-latest
    needs: frontend_tests
    steps:
      - uses: actions/checkout@v4

      - name: SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=tp8ingsoft3
            -Dsonar.organization=ignaciomagoia
            -Dsonar.sources=.
            -Dsonar.host.url=https://sonarcloud.io


  ############################################
  # 4) CYPRESS E2E
  ############################################
  e2e_tests:
    runs-on: ubuntu-latest
    needs: sonarqube
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install frontend
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Install Cypress
        run: npm install cypress --force
        working-directory: frontend

      - name: Run Cypress tests
        run: npx cypress run
        working-directory: frontend


  ############################################
  # 5) BUILD ARTIFACTS (BACKEND + FRONTEND)
  ############################################
  build_artifacts:
    runs-on: ubuntu-latest
    needs: e2e_tests

    steps:
      - uses: actions/checkout@v4

      ### BACKEND ###
      - uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - name: Build backend binary
        run: go build -o app .
        working-directory: backend

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-app
          path: backend/app

      ### FRONTEND ###
      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/**


  ############################################
  # 6) AUTO-DEPLOY QA
  ############################################
  deploy_qa:
    runs-on: ubuntu-latest
    needs: build_artifacts

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      ### BACKEND ###
      - uses: actions/download-artifact@v4
        with:
          name: backend-app
          path: backend

      - name: Deploy BACKEND to QA
        uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-back-qa
          package: backend/app

      ### FRONTEND ###
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend

      - name: Deploy FRONTEND to QA
        uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-front-qa
          package: frontend/build


  ############################################
  # 7) APPROVAL (MANUAL) COMO TP05
  ############################################
  approval_gate:
    runs-on: ubuntu-latest
    needs: deploy_qa

    steps:
      - name: Manual Approval
        run: |
          echo "⚠ Esperando aprobación manual desde GitHub Actions..."
          echo "Vaya a: Actions → el workflow → Review deployments → Approve"


  ############################################
  # 8) DEPLOY TO PROD
  ############################################
  deploy_prod:
    runs-on: ubuntu-latest
    needs: approval_gate

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      ### BACKEND ###
      - uses: actions/download-artifact@v4
        with:
          name: backend-app
          path: backend

      - name: Deploy BACKEND to PROD
        uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-back-prod
          package: backend/app

      ### FRONTEND ###
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend

      - name: Deploy FRONTEND to PROD
        uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-front-prod
          package: frontend/build
