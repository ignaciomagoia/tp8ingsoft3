name: Full CI/CD Pipeline (QA â†’ PROD)

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:

env:
  RG: rg-tp8-cicd

# =====================================================================
#                               CI STAGES
# =====================================================================
jobs:

  # ---------------- BACKEND TESTS ----------------
  backend-tests:
    name: Backend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - run: |
          go test ./... -coverprofile=coverage.out
          go tool cover -func=coverage.out

      - uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.out


  # ---------------- FRONTEND TESTS ----------------
  frontend-tests:
    name: Frontend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
      - run: npm test -- --coverage --watchAll=false

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage/lcov-report


  # ---------------- SONARCLOUD ----------------
  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  # ---------------- CYPRESS E2E ----------------
  e2e-tests:
    name: E2E tests (Cypress)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    defaults:
      run:
        shell: bash
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
      - run: npm run e2e
        env:
          CYPRESS_BASE_URL: http://localhost:3000

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-artifacts
          path: |
            frontend/cypress/videos
            frontend/cypress/screenshots
          if-no-files-found: ignore


# =====================================================================
#                         BUILD ARTIFACTS
# =====================================================================
  build_artifacts:
    name: Build artifacts (Back & Front)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, sonarcloud-analysis, e2e-tests]

    steps:
      - uses: actions/checkout@v4

      # ---- BACKEND BUILD (ZIP!) ----
      - name: Build backend
        working-directory: backend
        run: |
          go build -o app .
          zip -j app.zip app

      - uses: actions/upload-artifact@v4
        with:
          name: backend-app
          path: backend/app.zip

      # ---- FRONTEND BUILD (ZIP!) ----
      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
          echo "Agregando web.config..."
          cp web.config build/
          zip -r build.zip build

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build.zip


# =====================================================================
#                         DEPLOY QA
# =====================================================================
  deploy_qa:
    name: Deploy QA Web Apps
    runs-on: ubuntu-latest
    needs: build_artifacts
    environment: qa

    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ---- DESCARGAR BACKEND ----
      - uses: actions/download-artifact@v4
        with:
          name: backend-app
          path: backend/

      # ---- DESCARGAR FRONTEND ----
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/

      # ---- DEPLOY BACKEND QA ----
      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-back-qa
          package: backend/app.zip

      - name: Set backend QA env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-back-qa \
            --settings \
              PORT=8080 \
              GO_ENV=production \
              MONGO_URI="${{ secrets.MONGO_URI_QA }}" \
              FRONT_ORIGINS="https://tp8-front-qa.azurewebsites.net"

      # ---- DEPLOY FRONTEND QA ----
      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-front-qa
          package: frontend/build.zip

      - name: Set frontend QA env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-front-qa \
            --settings VITE_API_URL="https://tp8-back-qa.azurewebsites.net"


# =====================================================================
#                       APPROVAL GATE
# =====================================================================
  approve_prod:
    name: Approval Gate
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment: prod

    steps:
      - run: echo "Esperando aprobaciÃ³n para PRODâ€¦"


# =====================================================================
#                         DEPLOY PROD
# =====================================================================
  deploy_prod:
    name: Deploy PROD Web Apps
    runs-on: ubuntu-latest
    needs: approve_prod
    environment: prod

    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ---- DESCARGAR BACKEND ----
      - uses: actions/download-artifact@v4
        with:
          name: backend-app
          path: backend/

      # ---- DESCARGAR FRONTEND ----
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/

      # ---- DEPLOY BACKEND PROD ----
      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-back-prod
          package: backend/app.zip

      - name: Set backend PROD env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-back-prod \
            --settings \
              PORT=8080 \
              GO_ENV=production \
              MONGO_URI="${{ secrets.MONGO_URI_PROD }}" \
              FRONT_ORIGINS="https://tp8-front-prod.azurewebsites.net"

      # ---- DEPLOY FRONTEND PROD ----
      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-front-prod
          package: frontend/build.zip

      - name: Set frontend PROD env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-front-prod \
            --settings VITE_API_URL="https://tp8-back-prod.azurewebsites.net"

      - run: |
          echo "====================================="
          echo "       ðŸš€ DEPLOY COMPLETO EN PROD"
          echo "ðŸ‘‰ https://tp8-front-prod.azurewebsites.net"
          echo "====================================="
