name: Full CI/CD Pipeline - TP08

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  RG: rg-tp8-cicd

jobs:
  # ============================
  # BACKEND TESTS
  # ============================
  backend_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - run: go test ./... -v


  # ============================
  # FRONTEND TESTS
  # ============================
  frontend_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
        working-directory: frontend

      - run: npm test --watchAll=false
        working-directory: frontend


  # ============================
  # SONARCLOUD ANALYSIS
  # ============================
  sonarcloud:
    runs-on: ubuntu-latest
    needs: [backend_tests, frontend_tests]

    steps:
      - uses: actions/checkout@v4

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


  # ============================
  # CYPRESS E2E TESTS
  # ============================
  e2e_tests:
    runs-on: ubuntu-latest
    needs: sonarcloud

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
        working-directory: frontend

      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend


  # ============================
  # BUILD ARTIFACTS
  # ============================
  build_artifacts:
    runs-on: ubuntu-latest
    needs: e2e_tests

    steps:
      - uses: actions/checkout@v4

      # ------ Backend build ------
      - name: Build backend
        run: go build -o app .
        working-directory: backend

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-app
          path: backend/app


      # ------ Frontend build ------
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
        working-directory: frontend

      - run: npm run build
        working-directory: frontend

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build


  # ============================
  # DEPLOY QA
  # ============================
  deploy_qa:
    runs-on: ubuntu-latest
    needs: build_artifacts
    environment: qa

    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -------- BACKEND --------
      - uses: actions/download-artifact@v4
        with:
          name: backend-app
          path: backend_zip

      - name: Unzip backend
        run: |
          mkdir backend
          cp backend_zip/app backend/app
          ls -R backend

      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-back-qa
          package: backend/app

      - name: Set backend QA env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-back-qa \
            --settings \
              PORT=8080 \
              MONGO_URI="${{ secrets.MONGO_URI_QA }}" \
              FRONT_ORIGINS="${{ secrets.FRONT_ORIGINS_QA }}"

      # -------- FRONTEND --------
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend_dist

      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-front-qa
          package: frontend_dist

      - name: Set frontend QA env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-front-qa \
            --settings \
              VITE_API_URL="https://tp8-back-qa.azurewebsites.net"


  # ============================
  # APPROVAL GATE
  # ============================
  approval:
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment:
      name: prod
      url: https://tp8-front-prod.azurewebsites.net
    steps:
      - run: echo "Esperando aprobaci√≥n para PROD"


  # ============================
  # DEPLOY PROD
  # ============================
  deploy_prod:
    runs-on: ubuntu-latest
    needs: approval
    environment: prod

    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ------ Backend ------
      - uses: actions/download-artifact@v4
        with:
          name: backend-app
          path: backend_zip

      - name: Unzip backend
        run: |
          mkdir backend
          cp backend_zip/app backend/app
          ls -R backend

      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-back-prod
          package: backend/app

      - name: Set backend PROD env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-back-prod \
            --settings \
              PORT=8080 \
              MONGO_URI="${{ secrets.MONGO_URI_PROD }}" \
              FRONT_ORIGINS="${{ secrets.FRONT_ORIGINS_PROD }}"

      # ------ Frontend ------
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend_dist

      - uses: azure/webapps-deploy@v2
        with:
          app-name: tp8-front-prod
          package: frontend_dist

      - name: Set frontend PROD env
        run: |
          az webapp config appsettings set \
            -g $RG -n tp8-front-prod \
            --settings \
              VITE_API_URL="https://tp8-back-prod.azurewebsites.net"
