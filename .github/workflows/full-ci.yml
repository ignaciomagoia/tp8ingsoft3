name: Full CI/CD Pipeline (QA → PROD)

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:

env:
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/tp8-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/tp8-frontend

jobs:

  # =====================================================================
  #                           BACKEND TESTS
  # =====================================================================
  backend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - run: |
          go test ./... -coverprofile=coverage.out
          go tool cover -func=coverage.out
      - uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.out

  # =====================================================================
  #                           FRONTEND TESTS
  # =====================================================================
  frontend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npm test -- --coverage --watchAll=false
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/lcov-report

  # =====================================================================
  #                           SONARCLOUD
  # =====================================================================
  sonarcloud-analysis:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
      - uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: sonar
      - uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =====================================================================
  #                           E2E CYPRESS TESTS
  # =====================================================================
  e2e-tests:
    name: Cypress E2E Tests
    runs-on: ubuntu-latest
    needs: [frontend-tests]

    container: cypress/included:13.17.0  # ⬅️ IMAGEN OFICIAL CON CYPRESS INSTALADO

    defaults:
      run:
        shell: bash
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Install frontend deps
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Start frontend (preview mode)
        run: |
          npx vite preview --port 3000 &
          sleep 5

      - name: Run Cypress
        run: cypress run --browser chrome
        env:
          CYPRESS_BASE_URL: http://localhost:3000

  # =====================================================================
  #               BUILD & PUSH GHCR DOCKER IMAGES
  # =====================================================================
  build_images:
    runs-on: ubuntu-latest
    needs: e2e-tests

    steps:
      - uses: actions/checkout@v4

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend
        run: docker build -t $BACKEND_IMAGE:${{ github.sha }} backend

      - name: Tag backend
        run: |
          docker tag $BACKEND_IMAGE:${{ github.sha }} $BACKEND_IMAGE:qa-latest
          docker tag $BACKEND_IMAGE:${{ github.sha }} $BACKEND_IMAGE:prod-latest

      - name: Push backend
        run: |
          docker push $BACKEND_IMAGE:${{ github.sha }}
          docker push $BACKEND_IMAGE:qa-latest
          docker push $BACKEND_IMAGE:prod-latest

      - name: Build frontend
        run: docker build -t $FRONTEND_IMAGE:${{ github.sha }} frontend

      - name: Tag frontend
        run: |
          docker tag $FRONTEND_IMAGE:${{ github.sha }} $FRONTEND_IMAGE:qa-latest
          docker tag $FRONTEND_IMAGE:${{ github.sha }} $FRONTEND_IMAGE:prod-latest

      - name: Push frontend
        run: |
          docker push $FRONTEND_IMAGE:${{ github.sha }}
          docker push $FRONTEND_IMAGE:qa-latest
          docker push $FRONTEND_IMAGE:prod-latest

  # =====================================================================
  #                      DEPLOY QA
  # =====================================================================
  deploy_qa:
    runs-on: ubuntu-latest
    needs: build_images
    environment: qa

    steps:
      - run: curl -X POST "${{ secrets.RENDER_BACKEND_QA_HOOK }}"
      - run: curl -X POST "${{ secrets.RENDER_FRONTEND_QA_HOOK }}"

  # =====================================================================
  #                      APPROVAL GATE
  # =====================================================================
  approve_prod:
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment: prod

    steps:
      - run: echo "Esperando aprobación manual para PROD…"

  # =====================================================================
  #                      DEPLOY PROD
  # =====================================================================
  deploy_prod:
    runs-on: ubuntu-latest
    needs: approve_prod
    environment: prod

    steps:
      - run: curl -X POST "${{ secrets.RENDER_BACKEND_PROD_HOOK }}"
      - run: curl -X POST "${{ secrets.RENDER_FRONTEND_PROD_HOOK }}"
