name: Full CI/CD Pipeline

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  backend-tests:
    name: Backend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run Go tests with coverage
        run: |
          go test ./... -coverprofile=coverage.out
          go tool cover -func=coverage.out

      - name: Upload backend coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.out

  frontend-tests:
    name: Frontend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run frontend tests with coverage
        run: npm test -- --coverage --watchAll=false

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage/lcov-report

  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java (required for SonarCloud)
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  e2e-tests:
    name: E2E tests (Cypress)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    defaults:
      run:
        shell: bash
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Run Cypress (start + wait + run)
        env:
          CYPRESS_BASE_URL: http://localhost:3000
        run: npm run e2e

      - name: Upload Cypress artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            frontend/cypress/videos
            frontend/cypress/screenshots
          if-no-files-found: ignore

  build-and-push:
    name: Build & Push Docker images
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, sonarcloud-analysis, e2e-tests]
    env:
      BACKEND_IMAGE: ${{ secrets.ACR_LOGIN_SERVER }}/tp8-backend:${{ github.sha }}
      FRONTEND_IMAGE: ${{ secrets.ACR_LOGIN_SERVER }}/tp8-frontend:${{ github.sha }}
    outputs:
      backend_image: ${{ steps.image-refs.outputs.backend_image }}
      frontend_image: ${{ steps.image-refs.outputs.frontend_image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & push backend image
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}
            ${{ secrets.ACR_LOGIN_SERVER }}/tp8-backend:latest

      - name: Build & push frontend image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          file: frontend/dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}
            ${{ secrets.ACR_LOGIN_SERVER }}/tp8-frontend:latest

      - name: Expose image references
        id: image-refs
        run: |
          echo "backend_image=${BACKEND_IMAGE}" >> "$GITHUB_OUTPUT"
          echo "frontend_image=${FRONTEND_IMAGE}" >> "$GITHUB_OUTPUT"

  deploy-qa:
    name: Deploy QA (Azure Container Instances)
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: qa
    env:
      RESOURCE_GROUP: rg-tp8-cicd
      QA_MONGO_URI: ${{ secrets.MONGO_URI }}
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy containers to QA
        uses: azure/cli@v2
        with:
          azcliversion: 2.63.0
          inlineScript: |
            set -euo pipefail

            RG="$RESOURCE_GROUP"
            LOCATION=$(az group show --name "$RG" --query location -o tsv | tr '[:upper:]' '[:lower:]')
            BACKEND_IMAGE="${{ needs.build-and-push.outputs.backend_image }}"
            FRONTEND_IMAGE="${{ needs.build-and-push.outputs.frontend_image }}"
            BACKEND_NAME="tp8-backend-qa"
            FRONTEND_NAME="tp8-frontend-qa"
            BACKEND_DNS="tp8backendqa"
            FRONTEND_DNS="tp8frontendqa"

            delete_container() {
              local container_name="$1"
              if az container show --resource-group "$RG" --name "$container_name" >/dev/null 2>&1; then
                az container delete --resource-group "$RG" --name "$container_name" --yes
                az container wait --resource-group "$RG" --name "$container_name" --deleted
              fi
            }

            delete_container "$BACKEND_NAME"
            delete_container "$FRONTEND_NAME"

            az container create \
              --resource-group "$RG" \
              --name "$BACKEND_NAME" \
              --image "$BACKEND_IMAGE" \
              --registry-login-server "$ACR_LOGIN_SERVER" \
              --registry-username "$ACR_USERNAME" \
              --registry-password "$ACR_PASSWORD" \
              --dns-name-label "$BACKEND_DNS" \
              --ports 8080 \
              --ip-address Public \
              --restart-policy Always \
              --cpu 1 \
              --memory 2 \
              --environment-variables PORT=8080 \
              --secure-environment-variables MONGO_URI="$QA_MONGO_URI"

            BACKEND_FQDN="${BACKEND_DNS}.${LOCATION}.azurecontainer.io"
            QA_API_URL="http://${BACKEND_FQDN}:8080"

            az container create \
              --resource-group "$RG" \
              --name "$FRONTEND_NAME" \
              --image "$FRONTEND_IMAGE" \
              --registry-login-server "$ACR_LOGIN_SERVER" \
              --registry-username "$ACR_USERNAME" \
              --registry-password "$ACR_PASSWORD" \
              --dns-name-label "$FRONTEND_DNS" \
              --ports 80 \
              --ip-address Public \
              --restart-policy Always \
              --cpu 1 \
              --memory 1.5 \
              --environment-variables PORT=80 VITE_API_URL="$QA_API_URL" REACT_APP_API_URL="$QA_API_URL"

  deploy-prod:
    name: Deploy PROD (Azure App Service)
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-qa]
    environment: prod
    env:
      RESOURCE_GROUP: rg-tp8-cicd
      PROD_MONGO_URI: ${{ secrets.MONGO_URI }}
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Web Apps
        uses: azure/cli@v2
        with:
          azcliversion: 2.63.0
          inlineScript: |
            set -euo pipefail

            RG="$RESOURCE_GROUP"
            LOCATION=$(az group show --name "$RG" --query location -o tsv)
            PLAN_NAME="tp8-linux-plan"
            BACKEND_APP="tp8-backend-prod"
            FRONTEND_APP="tp8-frontend-prod"
            BACKEND_IMAGE="${{ needs.build-and-push.outputs.backend_image }}"
            FRONTEND_IMAGE="${{ needs.build-and-push.outputs.frontend_image }}"
            REGISTRY_URL="https://${ACR_LOGIN_SERVER}"

            if ! az appservice plan show --name "$PLAN_NAME" --resource-group "$RG" >/dev/null 2>&1; then
              az appservice plan create --name "$PLAN_NAME" --resource-group "$RG" --is-linux --sku B1 --location "$LOCATION"
            fi

            if ! az webapp show --name "$BACKEND_APP" --resource-group "$RG" >/dev/null 2>&1; then
              az webapp create --name "$BACKEND_APP" --resource-group "$RG" --plan "$PLAN_NAME" --deployment-container-image-name "$BACKEND_IMAGE"
            fi

            az webapp config container set \
              --name "$BACKEND_APP" \
              --resource-group "$RG" \
              --docker-custom-image-name "$BACKEND_IMAGE" \
              --docker-registry-server-url "$REGISTRY_URL" \
              --docker-registry-server-user "$ACR_USERNAME" \
              --docker-registry-server-password "$ACR_PASSWORD"

            az webapp config appsettings set \
              --name "$BACKEND_APP" \
              --resource-group "$RG" \
              --settings WEBSITES_PORT=8080 PORT=8080 \
              --slot-settings MONGO_URI="$PROD_MONGO_URI"

            BACKEND_URL="https://${BACKEND_APP}.azurewebsites.net"

            if ! az webapp show --name "$FRONTEND_APP" --resource-group "$RG" >/dev/null 2>&1; then
              az webapp create --name "$FRONTEND_APP" --resource-group "$RG" --plan "$PLAN_NAME" --deployment-container-image-name "$FRONTEND_IMAGE"
            fi

            az webapp config container set \
              --name "$FRONTEND_APP" \
              --resource-group "$RG" \
              --docker-custom-image-name "$FRONTEND_IMAGE" \
              --docker-registry-server-url "$REGISTRY_URL" \
              --docker-registry-server-user "$ACR_USERNAME" \
              --docker-registry-server-password "$ACR_PASSWORD"

            az webapp config appsettings set \
              --name "$FRONTEND_APP" \
              --resource-group "$RG" \
              --settings WEBSITES_PORT=80 PORT=80 VITE_API_URL="$BACKEND_URL" REACT_APP_API_URL="$BACKEND_URL"

            az webapp restart --name "$BACKEND_APP" --resource-group "$RG"
            az webapp restart --name "$FRONTEND_APP" --resource-group "$RG"

  summary:
    name: Pipeline summary
    runs-on: ubuntu-latest
    needs:
      [
        backend-tests,
        frontend-tests,
        sonarcloud-analysis,
        e2e-tests,
        build-and-push,
        deploy-qa,
        deploy-prod,
      ]
    if: ${{ always() }}
    steps:
      - name: Show summary
        run: |
          echo "Backend tests: ${{ needs.backend-tests.result }}"
          echo "Frontend tests: ${{ needs.frontend-tests.result }}"
          echo "SonarCloud: ${{ needs.sonarcloud-analysis.result }}"
          echo "E2E: ${{ needs.e2e-tests.result }}"
          echo "Build & push: ${{ needs.build-and-push.result }}"
          echo "QA deploy: ${{ needs.deploy-qa.result }}"
          echo "PROD deploy: ${{ needs.deploy-prod.result }}"
